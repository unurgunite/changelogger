#!/usr/bin/env ruby
# frozen_string_literal: true

require "tmpdir"
require "fileutils"

orig_dir = Dir.pwd
repo_spec = ARGV[0]&.strip
tmp_dir = nil

def looks_like_url?(s)
  s =~ %r{\Ahttps?://} || s.start_with?("git@")
end

def github_slug_to_url(s)
  # Accepts:
  # - owner/repo
  # - github.com/owner/repo
  # - https://github.com/owner/repo(.git)
  if s =~ %r{\Ahttps?://(?:www\.)?github\.com/([\w.-]+/[\w.-]+)(?:\.git)?\z}i
    "https://github.com/#{Regexp.last_match(1)}.git"
  elsif s =~ %r{\A(?:github\.com/)?([\w.-]+/[\w.-]+)(?:\.git)?\z}i
    "https://github.com/#{Regexp.last_match(1)}.git"
  end
end

begin
  if repo_spec && !repo_spec.empty?
    if File.directory?(repo_spec)
      # Local path
      Dir.chdir(File.expand_path(repo_spec))
      unless system("git", "rev-parse", "--is-inside-work-tree", out: File::NULL, err: File::NULL)
        warn "#{repo_spec.inspect} is not a git repository. Continuing, but UI will be empty."
      end
    else
      # Remote URL or GitHub slug
      url = looks_like_url?(repo_spec) ? repo_spec : github_slug_to_url(repo_spec)
      if url
        tmp_dir = Dir.mktmpdir("changelogger-")
        clone_ok = system("git", "clone", "--no-checkout", "--filter=blob:none", "--depth=1000", url, tmp_dir,
                          out: File::NULL, err: File::NULL)
        # Fallback to full clone if shallow/filtered fails
        clone_ok ||= system("git", "clone", url, tmp_dir)
        if clone_ok
          Dir.chdir(tmp_dir)
        else
          warn "Failed to clone #{url}. Continuing in current directory."
        end
      else
        warn "Unrecognized repo argument: #{repo_spec.inspect}. Expected a directory, GitHub slug (owner/repo), or git URL."
      end
    end
  end

  # Launch the TUI
  require "changelogger"
ensure
  # Return to original directory and clean up any temp clone
  begin
    Dir.chdir(orig_dir)
  rescue StandardError
    nil
  end
  if tmp_dir && File.directory?(tmp_dir)
    begin
      FileUtils.remove_entry(tmp_dir)
    rescue StandardError
      nil
    end
  end
end
