#!/usr/bin/env bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

function log_error() {
  echo -e "${RED}ERROR: $1${NC}" >&2
}

function log_warn() {
  echo -e "${YELLOW}WARNING: $1${NC}" >&2
}

function log_success() {
  echo -e "${GREEN}$1${NC}"
}

function check_clean_working_directory() {
  if ! git diff-index --quiet HEAD --; then
    log_error "Working directory is not clean. Please commit or stash your changes."
    exit 1
  fi
}

function check_main_branch() {
  current_branch=$(git rev-parse --abbrev-ref HEAD)
  if [[ "$current_branch" != "main" && "$current_branch" != "master" ]]; then
    log_error "Must be on 'main' or 'master' branch to release. Current branch: $current_branch"
    exit 1
  fi
}

function check_version_tag_exists() {
  VERSION=$(ruby -e "require './lib/rubocop/sorted_methods_by_call/version'; puts RuboCop::SortedMethodsByCall::VERSION")

  if git rev-parse "v$VERSION" >/dev/null 2>&1; then
    log_error "Git tag v$VERSION already exists. Please update the version in version.rb first."
    exit 1
  fi

  echo "Preparing to release version $VERSION"
}

function confirm_release() {
  echo ""
  log_warn "This will:"
  echo "  • Build gem version $VERSION"
  echo "  • Create git tag v$VERSION"
  echo "  • Push tag to origin"
  echo "  • Publish to RubyGems"
  echo ""

  read -p "Are you sure you want to proceed? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log_warn "Release cancelled."
    exit 1
  fi
}

function build_gem() {
  log_success "Building gem..."
  gem build rubocop-sorted_methods_by_call.gemspec
}

function create_and_push_tag() {
  log_success "Creating and pushing git tag..."
  git tag "v$VERSION" -m "Release v$VERSION"
  git push origin "v$VERSION"
}

function publish_to_rubygems() {
  log_success "Publishing to RubyGems..."
  gem push "rubocop-sorted_methods_by_call-$VERSION.gem"
}

function main() {
  log_success "Starting release process..."

  check_clean_working_directory
  check_main_branch
  check_version_tag_exists
  confirm_release

  # Release steps
  build_gem
  create_and_push_tag
  publish_to_rubygems

  log_success "✅ Release v$VERSION completed successfully!"
  echo ""
  echo "Next steps:"
  echo "  • Create a GitHub release: https://github.com/$(git remote get-url origin | sed -E 's/.*github.com[:\/]([^\/]+\/[^.]+).*/\1/')/releases/new?tag=v$VERSION"
  echo "  • Update CHANGELOG.md for the next release"
}

main "$@"
